// Tiny QR solver, header only library
//
// Licensed under the MIT License <http://opensource.org/licenses/MIT>.
//
// Copyright (C) 2023- Juraj Szitas
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

#include <iostream>

#include "../tinyqr.h"
#include "./utils.h"

int main() {
  using scalar_t = float;
  const auto A = read_vec<scalar_t>("benchmarking/A2.txt");
  const auto y = read_vec<scalar_t>("benchmarking/y2.txt");

  auto coef = tinyqr::lm(A, y);
  std::cout << "Coefficients from runtime tinyqr::lm: \n";
  for (const auto& coef_ : coef) std::cout << coef_ << ",";
  std::cout << '\n';

  constexpr auto A2 = std::array<double, 800>{
      -1.23016455865039,   0.806120773556764,    1.05617862136795,
      2.03568327251154,    -0.0377582112813354,  -0.330660672055122,
      0.24266109087778,    -0.0519542197800207,  1.24809621830394,
      -0.529145137514604,  0.41599305467791,     0.780188413168427,
      -0.278042319092522,  -1.29292774220221,    0.613885779256731,
      -0.221627262376886,  -1.61283554964842,    0.3365768646106,
      0.408769635420449,   -1.06581956361996,    0.0288629810780833,
      -1.88985857367043,   1.1619642943254,      -1.04666920936005,
      1.28781544183124,    -1.87712287258224,    0.901422572041986,
      -0.515512510269722,  -0.00530567288834061, 0.752665824820631,
      0.787558806868727,   -0.401502484007842,   -0.384346568342644,
      -0.810361167954025,  -0.577274521244853,   -0.664476733954138,
      -1.46588844684717,   0.702663439206576,    -0.188392934642211,
      2.71521748393029,    2.1252013629743,      -0.807168190209702,
      0.764839939152893,   -0.106297711919223,   -1.09053585256322,
      -0.811292700627497,  0.441418584167126,    0.916226706065102,
      -1.5472934722332,    0.262566884973037,    -0.905433571766711,
      0.865083049043108,   -1.43627734982132,    1.18566417634812,
      -0.285919370454094,  0.269125667136493,    -1.39924447673086,
      0.936300672777117,   -1.17804098532624,    0.691489402216733,
      0.285204085527848,   -1.23052747789066,    -0.0901489673422202,
      0.477486951052084,   -0.430167820253334,   -0.702291382115323,
      2.51107934490503,    2.47084926777258,     -2.28208903008145,
      -0.067464057520658,  -0.0990643732870287,  -0.518108784117345,
      0.324939694212685,   0.531350881913768,    -1.27202605818565,
      0.954866089703316,   -0.0225850569908317,  -0.50332509710098,
      -0.720141999954734,  -0.968944746594207,   0.922117184687017,
      1.25272115714031,    -1.65856464381983,    -1.94344266483536,
      0.180914155135094,   -0.446329075593492,   0.602587355545102,
      -0.736805777166232,  0.5531119319992,      0.43587092280631,
      0.791935574467745,   -0.971715342074809,   0.911412345473041,
      -0.161064670588858,  -0.659322212201943,   -0.326992451408454,
      -0.868566041622743,  1.19459847601197,     -0.0865885031953684,
      -2.53067090423048,   1.2323134808429,      -1.18085293668287,
      -0.724074262106112,  1.08531039850012,     -0.484778665144074,
      -1.37628824604786,   0.00289383096049057,  0.606889652100123,
      1.22520649031273,    -0.923230179405588,   0.179159950659966,
      -1.06010313492103,   1.52033750571088,     0.137024664413474,
      -0.54490542501166,   -0.49095388856093,    1.20466357809225,
      -1.90010359057346,   0.506615897797353,    -0.861127793123756,
      0.163630457429395,   -0.888507885148706,   -1.16609400338645,
      0.526538472312584,   0.292223199474695,    1.32019922375373,
      -0.456152620364095,  0.288284603670147,    0.131680388427571,
      -0.227110797967617,  -0.661486151902747,   -1.98744019268058,
      1.35853981632985,    1.04075692186218,     -0.295588648838261,
      -2.03144192119199,   0.846745485707936,    0.147565726212913,
      1.07364590990082,    -0.584478128548118,   0.386682252286999,
      -1.77001878879128,   -3.20126352381517,    -0.592860059850387,
      0.209826840454102,   0.52234987954467,     2.7903003423529,
      1.87391531174745,    0.778005928374954,    -1.21577800867684,
      0.407873677996227,   0.748332770394677,    0.671683452348251,
      -0.0530789554306898, 0.325372916448132,    0.698876982897326,
      -0.146121486647371,  -1.36454640736435,    -2.30615258736189,
      -0.723293063790835,  -1.87093651732304,    -1.96484065900988,
      1.46791230699492,    0.0518555821327525,   0.284685315331494,
      -0.978801792790695,  -1.11465794163025,    -0.24161154004158,
      1.63162015824428,    0.908969597225631,    2.38582787472183,
      -0.208898556439871,  0.286678812724628,    -1.96024181461289,
      -1.14281614924146,   1.3050817428819,      -0.50301240519219,
      -0.463549898889231,  -0.571965359377419,   -1.37618521471316,
      1.06817142079548,    0.155053187184017,    0.480287304387053,
      1.24322052868292,    0.171053148927358,    1.8673080154763,
      0.773838705675032,   -0.918803268198583,   -0.370243239522186,
      -0.757167537185618,  -0.445794889603479,   -0.59278130283056,
      0.344227987787917,   0.935593445347653,    -0.217131399432226,
      0.604890390082112,   -2.01097915977761,    -0.0461153663323379,
      -0.711886758978992,  0.38153869413125,     0.152298226869144,
      1.13642045470882,    1.85362905690771,     0.710903016457879,
      -1.57379042544575,   0.260469385245727,    -1.26704242597503,
      0.233880916323135,   0.445608798826576,    0.724615642392463,
      -1.42789139293056,   1.22698631469909,     -0.885470262495603,
      -1.58968452275839,   -1.3945523406368,     -1.72732497427504,
      -1.02065485178591,   -0.443489054370765,   -1.64717200771576,
      0.345441115476799,   1.35984306866505,     0.600237388605413,
      0.780215350127482,   -1.13510567400698,    -0.843641102324972,
      -0.0772726127110135, -0.012075829375558,   0.986333473603046,
      0.935979618948115,   0.635961073369605,    0.64098606153585,
      -0.378432385034832,  -0.375361607113345,   1.91273851715391,
      1.29062363532035,    0.644631394784437,    0.862447550273468,
      0.392536707155036,   -0.65201401005983,    0.643147671634265,
      -0.032225604996445,  -1.09875508378123,    2.38717303145372,
      0.0300807387718644,  -1.17931982461446,    0.317667456668255,
      0.296507252280989,   -0.577073050477351,   0.326734590600476,
      -0.397967497788939,  -0.0583937624136489,  2.54776668319979,
      -1.45909299175788,   -0.689991714734679,   0.0843396453764853,
      0.149692207134146,   0.244646505688348,    -0.623685687623367,
      1.15326346557816,    -0.526502807525447,   -1.62783381053612,
      0.387979656769069,   0.517058090636578,    -2.35141980605891,
      -0.577709483605591,  -0.300076532743587,   -0.245057449358666,
      0.458219726216938,   -0.0310075051114396,  1.02436761731574,
      -0.578577143800238,  -1.38078562537288,    0.11400315064816,
      0.779010821662565,   -0.923995805134829,   2.15804022647962,
      0.375071454396198,   -0.613219879332152,   0.521552550134719,
      -0.30018579682893,   -1.34543741723448,    -0.504747467423623,
      -0.422531955931012,  0.192663474258265,    0.442401531142176,
      -0.379681735961379,  1.42583092374602,     0.407507576984745,
      -0.0415432608989165, -0.794497701467641,   1.83217768633903,
      -0.413937042415075,  0.698631223806073,    1.06529686342281,
      1.191375249014,      -0.357994555581147,   -0.733347770322276,
      -0.348523160558673,  0.813069295704578,    0.643795803904998,
      -0.0919003315727376, 1.15184412751518,     -0.988919927554811,
      0.331808456938333,   1.21329649655528,     0.0440037099478103,
      -0.557623342422848,  -0.026041896074576,   0.66465650483733,
      0.044438309466508,   0.15361487791408,     -0.0486848919372451,
      -1.37539622513853,   0.068679021687758,    -0.215474194442472,
      0.199010738387743,   0.747482099951934,    0.256861628896121,
      1.22528019706655,    -0.568043546511578,   1.43778850897245,
      1.59717329549342,    -0.539071932270209,   -1.20061254118661,
      1.21034401390828,    -1.27071581528396,    -0.156208561594981,
      -1.14742057919061,   0.267661994101661,    -2.03599704917991,
      0.0850379901565786,  0.332795589585844,    0.988663355857474,
      -0.440230011371773,  0.610190804634663,    -0.868558168583172,
      0.738175111488598,   -1.00319194097748,    -1.06296673243416,
      1.91774333770716,    -1.23280754459328,    0.419005764387369,
      -0.305364980070396,  -0.253071666476779,   -0.886773591765691,
      -1.22891558328586,   -1.24199956702572,    -0.420902698486859,
      1.16400288883645,    1.14676240079763,     -0.033532278558813,
      1.63745554446798,    0.627206606832339,    -1.6342845534509,
      0.324428934238388,   1.48819658586652,     1.27538662983981,
      -0.331052042596366,  0.340222396879459,    0.259920389777304,
      2.66734321025841,    0.339302959429537,    0.146149447412152,
      0.869499517786741,   2.23412518833628,     2.61941585869624,
      -0.317878699546858,  -0.790222167999338,   -0.772935379287293,
      -0.287412781981716,  0.71957741454329,     -1.38544316537378,
      0.410075936146441,   -1.75076905737866,    0.974896862068837,
      -0.693266742566781,  -0.45018609280948,    0.230428346586893,
      -0.0776284922553228, -0.301513364783201,   -0.21961063257334,
      -0.899461756786031,  -0.953359341548275,   0.855258038243978,
      0.868640128520293,   -0.563030341236487,   1.15103283385786,
      -0.308125430637681,  -1.58546252395175,    -0.593629696671128,
      -0.609472263682222,  0.389237299468684,    -0.00397554872016397,
      0.344303601449229,   0.0237161460466549,   -1.93427319895552,
      1.2223877939581,     -0.13727621001399,    -1.96339385075995,
      1.55674695673048,    0.156648679216186,    0.715289943031306,
      0.111744935431481,   0.101737245293973,    -0.371802999669768,
      0.651318846814089,   1.25188132930925,     0.764811736517302,
      0.847824608137177,   -0.847978919745301,   1.49608817265317,
      0.575202040100723,   -0.816128019245979,   -0.233659455729492,
      -0.289867892644071,  -0.48288583668039,    -0.152074574942118,
      -1.21031752565895,   0.7217507420963,      -0.628113332836573,
      1.0163602514972,     -0.319016802301004,   -1.29594375799903,
      -1.66853243335748,   2.4403652387213,      0.371503166875102,
      -0.79723534524135,   1.73847437127099,     0.324585808463683,
      0.494536628951483,   -0.322405649334756,   0.237098712630352,
      -0.241290608470111,  -0.622447739192389,   -0.685080444432925,
      -1.35711217410971,   0.576984228220051,    0.271817452883434,
      -0.246426901367644,  -0.449710427980704,   0.305771003469503,
      -0.936571731110618,  -0.712149973042654,   1.19022058591776,
      0.804830069119115,   -0.989879547442898,   0.714612108355673,
      0.239439736551657,   0.215257689804118,    0.986574208908184,
      -0.0678893275801987, 0.601302492939982,    0.804484862414385,
      1.15758881894667,    0.533502026958336,    0.280322453218138,
      -1.82532270451137,   -0.122570345730142,   0.649019707826916,
      0.0348859419176502,  -1.20079708740006,    0.0889417681946473,
      0.30097784668139,    0.640765218691096,    -0.199910623511081,
      0.717581234233622,   0.130679172268192,    0.0624483188309428,
      0.472880925560282,   0.0401306771316249,   -0.524313535535081,
      -1.69088340311064,   0.365860007839902,    1.35728500943923,
      -0.416711348826141,  -0.580651221609882,   0.914951823299469,
      0.164083954630239,   -0.452182811505342,   0.249067321737403,
      1.43184021688736,    0.243862164559897,    1.29611256934883,
      0.634101540286438,   1.81614192441325,     1.37430899191611,
      -0.326133144984691,  0.272499700891259,    -0.77097183402553,
      -0.759436138648772,  1.0412472734748,      -0.440220585743633,
      2.90842386910493,    -0.0745585974192178,  0.13946379248963,
      0.683064746525222,   1.27774326876467,     -0.159144569110787,
      -2.08279303382547,   0.976667769754392,    0.416298681165671,
      -0.125909221080845,  1.69013692524536,     0.515672447658384,
      -1.17368532246315,   -0.774409784959718,   0.0896363181266317,
      0.775534968424589,   -0.0767304434481199,  -1.20374684842414,
      -0.0173523745912422, -0.119934631153482,   -0.922615256541371,
      0.949124745092651,   -1.11617363275745,    0.044183094836249,
      1.27828742118429,    -0.631093483760773,   0.075236144783823,
      0.63482521394396,    1.27584443034155,     1.35399918737088,
      -0.667084606548323,  2.4356789298597,      0.54939692830486,
      0.636331924438704,   0.980221362914739,    0.741108051940729,
      -0.639507028339351,  -1.15965719123886,    0.26974621097965,
      -0.106700162159372,  2.50280571067305,     0.151663740291757,
      -0.467562445149324,  -0.367783462627346,   -0.933069212263833,
      1.01312160756348,    -2.01199892413889,    -1.20502003745079,
      1.83627182949511,    -0.539827539883007,   -0.573370193216277,
      0.222281231807049,   -0.923588036875001,   -0.581723810027326,
      -0.998956723465863,  -0.967138901162732,   0.490306026503779,
      0.683277078165973,   2.12628077046723,     -0.882910454830438,
      2.08461632915405,    -0.91080546503992,    0.00250221285017508,
      -0.20755724636599,   0.488593845509004,    -0.0609992900927054,
      -1.02816902528315,   0.153975337420331,    -1.76078969653688,
      -0.332689066785703,  -1.57720270349912,    0.262388364259701,
      -0.439068347438712,  1.58222507465185,     0.528087607266491,
      -0.16612687752563,   -0.388800575348653,   0.232506708525175,
      0.180389861643529,   0.416409580134016,    0.491782660943542,
      0.658926444260816,   1.40828399061445,     -0.37059938197192,
      -2.1516705381692,    0.929631122640498,    0.309389065733412,
      0.528117835352483,   0.246497502709917,    0.589795696631646,
      -1.42606664153026,   -1.54612884244851,    1.39225257310663,
      0.0549681550766178,  0.166696217913306,    -0.229363196029294,
      0.777719698741933,   1.2717862238467,      1.26398857594619,
      -0.164761511323568,  -0.218970059881498,   -1.56523958275739,
      0.491526998560849,   1.02864876576738,     1.73006831215892,
      0.304044568764042,   0.203349932249825,    -0.560466320037826,
      0.836038915615889,   -0.451375478779746,   1.19065402539903,
      -0.409362561775572,  -0.215030970978402,   0.0357640697026251,
      -0.136524792991276,  0.434996456566719,    -0.30162692111985,
      1.10092034909432,    0.835298235206543,    1.76539750576786,
      0.0555483798720398,  -0.722845673550476,   0.182269114706547,
      1.01902962020339,    -2.16185349176987,    0.392652948885703,
      -0.535374501089778,  0.712101339987991,    -0.691171123571075,
      -1.48691577629079,   -0.874470435021273,   0.591619825876631,
      0.207384931668382,   0.379560022601465,    0.143230563063222,
      0.81136753865467,    0.697062381708074,    -0.196892087667658,
      -0.506991611765543,  0.203420908592836,    -1.40652388823733,
      0.409385757098116,   0.401415022796397,    1.38553439507965,
      -0.593977628012223,  -0.740781102346227,   0.0722074404544877,
      -0.078718345507078,  -2.25002189919969,    0.596533751395076,
      0.797658663784445,   0.790911813177415,    -0.935325318949776,
      -0.19029460573649,   -0.391898911298546,   0.274429108461143,
      0.0673493478082943,  1.14989216275569,     0.218337084785878,
      -0.70927642553602,   -0.937483099310592,   1.00453403698793,
      -0.188838063052708,  0.283527637776607,    0.181731983432363,
      -1.11651687255578,   0.243968361842228,    0.781686921878669,
      -1.0360615839201,    0.906278984463495,    0.273894612109128,
      -0.215591112730467,  0.947110839115959,    -0.64557628087612,
      -0.302006967169809,  -1.37978581377075,    -1.60285793369284,
      0.12431645177293,    -0.693171250518534,   1.92235038725303,
      -0.214330128563155,  1.42921503289176,     0.439785851484754,
      -1.22850576631356,   -0.0192718820251237,  1.18157380128683,
      -0.502324762791517,  -0.715391181176191,   1.18944966476511,
      -0.692212439715007,  0.762608626161755,    -0.605925127180146,
      -0.572665114819649,  1.72925021328326,     0.39765226445557,
      -1.94299033751352,   0.0745931611569105,   -0.802607669205069,
      0.624078277436716,   1.09756685914676,     -0.881135172338764,
      0.0287321941389688,  -2.10027179402436,    0.192201913577703,
      0.0642829253061649,  1.13523757655967,     -0.43087359992054,
      1.04160505703232,    -1.02902458284299,    2.05335205700198,
      0.702377204378028,   -1.66871368094736,    -0.336259937138042,
      0.91726718390452,    -1.71728983626054,    -0.290614625587068,
      0.0550715365732217,  0.148848827616162,    1.58997561402668,
      -1.07611217679504,   -0.675658267825813,   1.5455166239824,
      0.221524294639515,   -0.960239462836185,   0.547604123341006,
      -1.01678891070277,   0.386850581144078,    0.864106724218313,
      0.172783235793665,   0.312287798593409,    0.844211149140089,
      -1.53707321085113,   -0.492543990503524,   -0.265102261148691,
      -1.13732356476577,   -1.48369174797577,    0.775164159225136,
      -0.276182695611632,  0.517816259938622,    0.43448520769371,
      -0.393760509569473,  -0.917276622145485,   -1.25772687721047,
      0.380787651060303,   1.74017339593655,     -0.299712297044771,
      -0.221827126406302,  0.0832558901778914,   1.02774672318518,
      0.0580390246565671,  1.77282910400783,     0.474560704915818,
      -2.01469087347848,   -1.78828846548386,    2.03135133803551,
      -2.37789358773115,   1.64003832026786,     -0.231862546195869,
      0.220562565376228,   -1.41404595563844,    1.35103155260794,
      0.061559389434172,   -1.38705976618434,    0.783385847440936,
      -1.24643733529157,   1.21902424727485,     0.845873993002917,
      -0.459561993681176,  0.855204909505927,    -2.47620945608593,
      -1.37862345181009,   -0.0832058429500137,  -0.693322468516101,
      -2.79699958185147,   -0.470021844800259,   0.819976481656961,
      0.325969953812121,   0.483670879395715,    -1.03485489978234,
      1.15731379635142,    -0.957372111764895,   -0.164786776336877,
      -0.434374332736756,  -0.978253761850342,   -0.0653027539503451,
      1.59223064227455,    0.526681142886638,    -0.197360449118292,
      0.0594933171230392,  -0.964951683053906,   -0.756394585549811,
      -0.800293551188019,  0.62165705084724,     0.874149113076389,
      -0.426197505136715,  -0.507537485915078,   0.285944202928745,
      -1.20888399502222,   0.828272011362287,    1.55593206321732,
      0.73018401435518,    0.423698480349459,    1.80325163978311,
      -0.194666659649504,  -1.22186170938231,    0.45224747528089,
      -0.772299960781825,  0.881271556269038};
  constexpr auto y2 = std::array<double, 100>{
      -0.217926712707124, -2.82449890847704,  0.951863791663332,
      2.57014259575748,   0.0324910695867575, -0.96002842354859,
      4.25893260093328,   2.25538890961166,   -0.243729973890492,
      -2.95318493984803,  2.82138695755259,   -0.485955277180982,
      1.49955949885765,   3.38504269240646,   1.50021403609611,
      1.29313807111332,   3.90106138718942,   -1.12063868214613,
      2.87131429068452,   -1.0390346045874,   -0.209897974272264,
      -1.88559795610723,  -4.4766004039232,   5.79842147958776,
      4.32677205796406,   3.88012674646094,   3.18582970454231,
      2.32198354035552,   -1.94411484676015,  1.04830186301395,
      -2.25688235188428,  -0.356867545150733, 2.16594538316601,
      -3.19464095171369,  -3.28706991569593,  -3.58288312116475,
      -3.32253813416353,  2.02270065875047,   -0.995421906531527,
      -4.09160305808239,  6.18740638324219,   -0.661481831449072,
      -6.73144628918109,  0.151605245804626,  4.17218969146283,
      -0.307178991839738, -0.148422317982099, 3.29231066538013,
      -0.993323123242613, 1.11801511643128,   2.68593945508846,
      -6.11982847893105,  3.95510872725376,   2.2299105745643,
      0.558947453618111,  -1.46811077713913,  -4.63633347080563,
      0.423562505414339,  -6.31993878356292,  1.74866884625434,
      -4.74168129917399,  -0.662223285629303, 0.516189796801035,
      6.09539197166283,   -2.54742108147453,  2.69716457969926,
      3.25692968624814,   0.287301711766287,  1.58542808019965,
      -0.382981223986894, -0.390073732680154, 1.63558409392666,
      0.608387253750157,  2.19918158314994,   2.03122644198629,
      -1.9035345926456,   -1.33615173739038,  1.1132437356558,
      -1.46073992284958,  2.81929239925535,   6.10961425864775,
      3.34808537455497,   0.864808318392654,  -2.21496313305012,
      2.42176928324964,   3.65285042080264,   -2.60374215719087,
      1.08904868703141,   1.64765651064037,   4.08487291741829,
      -0.663751496756148, -2.38283039021837,  1.1001945830173,
      -4.00074573465203,  -1.54664671046264,  3.45405599409924,
      1.7180415383602,    0.23800495612579,   -2.82440367832949,
      -4.30707227267612};

  std::cout << "Coefficients from compile-time tinyqr::lm: \n";
  auto coef_ = tinyqr::clm<double, 100, 8>(A2, y2);
  for (const auto& coef__ : coef_) std::cout << coef__ << ",";
  std::cout << '\n';

  return 0;
}
